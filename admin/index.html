<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link
      rel="icon"
      href="https://res.cloudinary.com/comixall/image/upload/favicon/favicon.ico"
      type="image/x-icon"
    />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #4a55a2;
        --secondary: #3a4282;
        --error: #e53e3e;
        --success: #38a169;
        --warning: #dd6b20;
        --text-dark: #2d3748;
        --text-light: #f7fafc;
        --text-gray: #718096;
        --bg-main: #edf2f7;
        --bg-card: #ffffff;
        --border-color: #e2e8f0;
        --border-radius: 12px;
        --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --box-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --ease-out-quint: cubic-bezier(0.23, 1, 0.32, 1);
        --ease-out-cubic: cubic-bezier(0.215, 0.61, 0.355, 1);
      }

      html[data-theme="dark"] {
        --primary: #90cdf4;
        --secondary: #63b3ed;
        --text-dark: #edf2f7;
        --text-light: #1a202c;
        --text-gray: #a0aec0;
        --bg-main: #1a202c;
        --bg-card: #2d3748;
        --border-color: #4a5568;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-main);
        color: var(--text-dark);
        line-height: 1.6;
        transition: background-color 0.3s ease-out, color 0.3s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(15px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes scaleIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }

        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes slideInRight {
        from {
          transform: translateX(110%);
          opacity: 0;
        }

        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .auth-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 1rem;
      }

      .auth-card {
        background: var(--bg-card);
        width: 100%;
        max-width: 420px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow-lg);
        animation: scaleIn 0.5s var(--ease-out-cubic) forwards;
      }

      .auth-header {
        background: var(--primary);
        color: white;
        padding: 2rem;
        text-align: center;
      }

      #search-comics {
        margin-bottom: 20px;
      }

      .auth-header h2 {
        font-weight: 600;
        margin: 0;
        font-size: 1.5rem;
      }

      .auth-body {
        padding: 2rem 2.5rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-dark);
        font-size: 0.875rem;
      }

      .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: border-color 0.25s ease-out, box-shadow 0.25s ease-out,
          background-color 0.25s ease-out;
        background-color: var(--bg-main);
        color: var(--text-dark);
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px
          color-mix(in srgb, var(--primary) 20%, transparent);
        background-color: var(--bg-card);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        border: 1px solid transparent;
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease-out, transform 0.2s ease-out,
          box-shadow 0.2s ease-out, color 0.2s ease-out,
          border-color 0.2s ease-out;
        text-decoration: none;
      }

      .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }

      .btn-xs {
        padding: 0.2rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 6px;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn:active {
        transform: scale(0.98);
      }

      .btn-block {
        display: flex;
        width: 100%;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: var(--box-shadow);
      }

      .btn-primary:hover:not(:disabled) {
        background: var(--secondary);
        box-shadow: var(--box-shadow-lg);
        transform: translateY(-2px);
      }

      .btn-danger {
        background: var(--error);
        color: white;
      }

      .btn-danger:hover:not(:disabled) {
        background: #c53030;
        transform: translateY(-2px);
      }

      .btn-warning {
        background: var(--warning);
        color: white;
      }

      .btn-warning:hover:not(:disabled) {
        background: #c05621;
        transform: translateY(-2px);
      }

      .btn-outline {
        background: transparent;
        border-color: var(--border-color);
        color: var(--text-dark);
      }

      .btn-outline:hover:not(:disabled) {
        background: var(--bg-main);
        border-color: var(--primary);
        color: var(--primary);
      }

      .error-message {
        color: var(--error);
        font-size: 0.875rem;
        margin-top: 1rem;
        text-align: center;
      }

      .loading-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      .btn .loading-spinner {
        margin-right: 8px;
      }

      .btn-outline .loading-spinner {
        border-top-color: var(--primary);
        border-left-color: var(--primary);
        border-bottom-color: var(--primary);
        border-right-color: transparent;
      }

      .hidden {
        display: none !important;
      }

      .admin-container {
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: 250px;
        background: var(--bg-card);
        box-shadow: 2px 0 15px rgba(0, 0, 0, 0.05);
        padding: 1.5rem 0;
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        z-index: 1100;
        transition: transform 0.35s var(--ease-out-cubic);
      }

      .sidebar-header {
        padding: 0 1.5rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
      }

      .sidebar-header h2 {
        color: var(--primary);
        font-size: 1.3rem;
        font-weight: 700;
        display: flex;
        align-items: center;
      }

      .sidebar-header h2 i {
        margin-right: 0.75rem;
      }

      .sidebar-menu {
        padding: 1rem 0;
      }

      .menu-item {
        display: flex;
        align-items: center;
        padding: 0.85rem 1.5rem;
        color: var(--text-gray);
        text-decoration: none;
        margin: 0.25rem 1rem;
        border-radius: var(--border-radius);
        transition: color 0.2s ease-out, background-color 0.2s ease-out;
      }

      .menu-item:hover,
      .menu-item.active {
        color: var(--primary);
        background: color-mix(in srgb, var(--primary) 8%, transparent);
      }

      .menu-item.active {
        font-weight: 600;
      }

      .menu-item i {
        margin-right: 0.75rem;
        width: 20px;
        text-align: center;
        transition: transform 0.2s ease;
      }

      .menu-item:hover i {
        transform: scale(1.1);
      }

      .main-content {
        flex: 1;
        margin-left: 250px;
        padding: 2rem;
        transition: margin-left 0.35s var(--ease-out-cubic);
      }

      .section-content {
        display: none;
      }

      .section-content.is-active {
        display: block;
        animation: fadeInUp 0.5s var(--ease-out-cubic) forwards;
      }

      .header {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 2rem;
      }

      .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-dark);
        cursor: pointer;
      }

      .header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-right: auto;
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-profile img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
      }

      .theme-toggle-btn,
      .logout-btn {
        background: none;
        border: none;
        color: var(--text-gray);
        cursor: pointer;
        font-size: 1.25rem;
        transition: color 0.2s ease-out, background-color 0.2s ease-out;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: grid;
        place-items: center;
      }

      .theme-toggle-btn:hover,
      .logout-btn:hover {
        color: var(--primary);
        background-color: color-mix(in srgb, var(--primary) 10%, transparent);
      }

      .logout-btn:hover {
        color: var(--error);
        background-color: color-mix(in srgb, var(--error) 10%, transparent);
      }

      .stats-container {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .comics-grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        align-items: stretch;
      }

      .stat-card,
      .comic-card,
      .form-card {
        background: var(--bg-card);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        transition: transform 0.25s var(--ease-out-quint),
          box-shadow 0.25s var(--ease-out-quint);
        animation: fadeInUp 0.5s var(--ease-out-cubic) forwards;
        opacity: 0;
      }

      .comic-card {
        display: flex;
        flex-direction: column;
        overflow: hidden;
        cursor: pointer;
      }

      .stats-container .stat-card,
      .comics-grid .comic-card {
        animation-delay: calc(0.08s * var(--i));
      }

      .stat-card:hover,
      .comic-card:hover,
      .form-card:hover {
        transform: translateY(-6px);
        box-shadow: var(--box-shadow-lg);
      }

      .stat-card {
        padding: 1.5rem;
      }

      .stat-card .stat-title {
        font-size: 0.875rem;
        color: var(--text-gray);
        margin-bottom: 0.5rem;
      }

      .stat-card .stat-value {
        font-size: 2rem;
        font-weight: 700;
      }

      .form-card {
        padding: 2rem;
        margin-bottom: 2rem;
      }

      .form-card h2 {
        font-size: 1.5rem;
        margin: 0 0 1.5rem 0;
        font-weight: 600;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      textarea.form-control {
        min-height: 120px;
        resize: vertical;
      }

      .comic-card .image-container {
        width: 100%;
        aspect-ratio: 2 / 3;
        overflow: hidden;
        background-color: var(--bg-main);
      }

      .comic-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease-out;
      }

      .comic-card:hover img {
        transform: scale(1.05);
      }

      .comic-card .comic-body {
        padding: 0.75rem;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
      }

      .comic-title {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.1rem;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
        text-overflow: ellipsis;
        min-height: 2.25rem;
      }

      .comic-author {
        font-size: 0.75rem;
        color: var(--text-gray);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .modal.show {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background: var(--bg-card);
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--box-shadow-lg);
        transition: transform 0.3s var(--ease-out-cubic), opacity 0.3s ease;
        transform: scale(0.95);
        opacity: 0;
      }

      .modal.show .modal-content {
        transform: scale(1);
        opacity: 1;
      }

      .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-gray);
        transition: transform 0.3s ease, color 0.2s ease;
      }

      .modal-close:hover {
        transform: rotate(90deg);
        color: var(--text-dark);
      }

      .modal-body {
        padding: 1.5rem;
      }

      .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        background-color: var(--bg-main);
        border-bottom-left-radius: var(--border-radius);
        border-bottom-right-radius: var(--border-radius);
      }

      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
      }

      .toast {
        background: var(--bg-card);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow-lg);
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        min-width: 320px;
        opacity: 0;
        animation: slideInRight 0.5s cubic-bezier(0.215, 0.61, 0.355, 1)
          forwards;
        position: relative;
        overflow: hidden;
      }

      .toast.hide {
        transition: all 0.4s ease-in;
        opacity: 0;
        transform: translateX(110%);
      }

      .toast::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 5px;
        height: 100%;
      }

      .toast-success::before {
        background: var(--success);
      }

      .toast-error::before {
        background: var(--error);
      }

      .toast-warning::before {
        background: var(--warning);
      }

      .toast-icon {
        margin-right: 1rem;
        font-size: 1.5rem;
      }

      .toast-success .toast-icon {
        color: var(--success);
      }

      .toast-error .toast-icon {
        color: var(--error);
      }

      .toast-warning .toast-icon {
        color: var(--warning);
      }

      .toast-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .toast-message {
        font-size: 0.875rem;
        color: var(--text-gray);
      }

      .toast-close {
        background: none;
        border: none;
        color: var(--text-gray);
        cursor: pointer;
        margin-left: auto;
        font-size: 1.25rem;
        padding: 0.5rem;
      }

      .category-admin-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .category-admin-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--bg-main);
        padding: 0.75rem 1.25rem;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        margin-bottom: 0.75rem;
        transition: transform 0.2s ease-out, box-shadow 0.2s ease-out,
          border-color 0.2s ease-out;
        animation: fadeInUp 0.4s ease-out forwards;
        opacity: 0;
        animation-delay: calc(0.05s * var(--i));
      }

      .category-admin-item:hover {
        transform: translateY(-3px);
        box-shadow: var(--box-shadow);
        border-color: var(--primary);
      }

      .category-admin-item span {
        font-weight: 500;
      }

      .activity-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      #recent-activity-list {
        max-height: 350px;
        overflow-y: auto;
        padding-right: 10px;
      }

      .activity-item {
        display: flex;
        gap: 1rem;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
      }

      .activity-item:last-child {
        border-bottom: none;
      }

      .activity-details {
        font-size: 0.9rem;
        flex-grow: 1;
      }

      .activity-details strong {
        color: var(--primary);
      }

      .activity-time {
        font-size: 0.8rem;
        color: var(--text-gray);
        flex-shrink: 0;
      }

      .delete-activity-btn {
        background: none;
        border: none;
        color: var(--text-gray);
        cursor: pointer;
        padding: 0.2rem 0.5rem;
        border-radius: 50%;
        transition: color 0.2s ease, background-color 0.2s ease;
      }

      .delete-activity-btn:hover {
        color: var(--error);
        background-color: color-mix(in srgb, var(--error) 10%, transparent);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .card-header h2 {
        margin: 0;
      }

      .settings-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-color);
      }

      .settings-item:last-child {
        border-bottom: none;
      }

      .settings-item-label h3 {
        margin: 0 0 0.25rem;
        font-size: 1rem;
        font-weight: 500;
      }

      .settings-item-label p {
        margin: 0;
        font-size: 0.875rem;
        color: var(--text-gray);
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 28px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 28px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--primary);
      }

      input:checked + .slider:before {
        transform: translateX(22px);
      }

      .preset-avatars-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .preset-avatar {
        width: 100%;
        aspect-ratio: 1 / 1;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.2s ease-out, border-color 0.2s ease-out,
          box-shadow 0.2s ease-out;
        border: 3px solid transparent;
        background-color: var(--bg-main);
      }

      .preset-avatar:hover {
        transform: scale(1.1);
        border-color: color-mix(in srgb, var(--primary) 50%, transparent);
      }

      .preset-avatar.selected {
        border-color: var(--primary);
        box-shadow: 0 0 10px color-mix(in srgb, var(--primary) 40%, transparent);
        transform: scale(1.1);
      }

      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1099;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .sidebar-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .user-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }

      .user-table th,
      .user-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
        white-space: nowrap;
      }

      .user-table th {
        background-color: var(--bg-main);
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
      }

      .user-table th:last-child,
      .user-table td:last-child {
        text-align: right;
      }

      .user-table tbody tr {
        transition: background-color 0.2s ease;
      }

      .user-table tbody tr:hover {
        background-color: var(--bg-main);
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }

      .charts-container {
        display: grid;
        gap: 1.5rem;
        margin-top: 2rem;
        grid-template-columns: 1fr;
      }

      @media (min-width: 992px) {
        .charts-container {
          grid-template-columns: 2fr 1fr;
        }
      }

      .chart-card {
        background: var(--bg-card);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 1.5rem;
        animation: fadeInUp 0.5s var(--ease-out-cubic) forwards;
        opacity: 0;
      }

      .chart-wrapper {
        position: relative;
        height: 400px;
      }

      .chart-card h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
      }

      @media (max-width: 992px) {
        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.show {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .mobile-menu-btn {
          display: inline-flex;
        }
      }

      @media (max-width: 768px) {
        .main-content {
          padding: 1.5rem;
        }

        .header h1 {
          font-size: 1.5rem;
        }

        .form-card,
        .auth-body,
        .auth-header {
          padding: 1.5rem;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .stats-container {
          grid-template-columns: 1fr 1fr;
        }

        #comics-section .header,
        #users-section .card-header {
          flex-direction: column;
          align-items: stretch;
        }

        #comics-section .header .form-group,
        #users-section .card-header .form-group {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        .main-content {
          padding: 1rem;
        }

        .header h1 {
          font-size: 1.25rem;
        }

        .toast {
          width: calc(100% - 2rem);
          right: 1rem;
          top: 1rem;
        }

        .stats-container {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <div id="auth-container" class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <h2>Admin Login</h2>
        </div>
        <div class="auth-body">
          <div id="login-form">
            <div class="form-group">
              <label for="login-email">Email</label>
              <input
                type="email"
                id="login-email"
                class="form-control"
                placeholder="Enter your email"
              />
            </div>
            <div class="form-group">
              <label for="login-password">Password</label>
              <input
                type="password"
                id="login-password"
                class="form-control"
                placeholder="Enter your password"
              />
            </div>
            <button id="login-btn" class="btn btn-primary btn-block">
              <span id="login-spinner" class="loading-spinner hidden"></span>
              <span id="login-text">Login</span>
            </button>
            <p id="login-error" class="error-message"></p>
          </div>
        </div>
      </div>
    </div>

    <div id="admin-dashboard" class="admin-container hidden">
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h2><i class="fas fa-book-open"></i> <span>ComixAll</span></h2>
        </div>
        <div class="sidebar-menu">
          <a href="#" class="menu-item active" data-section="dashboard"
            ><i class="fas fa-home"></i><span>Dashboard</span></a
          >
          <a href="#" class="menu-item" data-section="comics"
            ><i class="fas fa-book"></i><span>Comics</span></a
          >
          <a href="#" class="menu-item" data-section="categories"
            ><i class="fas fa-tags"></i><span>Categories</span></a
          >
          <a href="#" class="menu-item" data-section="users"
            ><i class="fas fa-users"></i><span>Users</span></a
          >
          <a href="#" class="menu-item" data-section="settings"
            ><i class="fas fa-cog"></i><span>Settings</span></a
          >
        </div>
      </div>

      <div class="sidebar-overlay" id="sidebar-overlay"></div>

      <div class="main-content">
        <header class="header">
          <button class="mobile-menu-btn" id="mobile-menu-btn">
            <i class="fas fa-bars"></i>
          </button>
          <h1 id="section-title">Dashboard</h1>
          <div class="user-profile">
            <button
              class="theme-toggle-btn"
              id="theme-toggle-btn"
              title="Toggle Theme"
            >
              <i class="fas fa-moon"></i>
            </button>
            <img
              id="user-profile-img"
              src="https://ui-avatars.com/api/?name=Admin&background=4A55A2&color=fff&font-size=0.5"
              alt="Admin"
              title="Change Profile Picture"
            />
            <button class="logout-btn" id="logout-btn" title="Logout">
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
        </header>

        <div id="dashboard-section" class="section-content">
          <div class="stats-container">
            <div class="stat-card" style="--i: 1">
              <div class="stat-title">Total Comics</div>
              <div class="stat-value" id="total-comics">0</div>
            </div>
            <div class="stat-card" style="--i: 2">
              <div class="stat-title">Total Users</div>
              <div class="stat-value" id="active-users">0</div>
            </div>
            <div class="stat-card" style="--i: 3">
              <div class="stat-title">Total Views</div>
              <div class="stat-value" id="page-views">0</div>
            </div>
            <div class="stat-card" style="--i: 4">
              <div class="stat-title">Storage Used</div>
              <div class="stat-value" id="storage-used">N/A</div>
            </div>
          </div>

          <div class="form-card" style="margin-top: 2rem; --i: 5">
            <div class="card-header">
              <h2>Recent Activity</h2>
              <button
                id="delete-all-activities-btn"
                class="btn btn-danger btn-sm"
              >
                Delete All
              </button>
            </div>
            <div id="recent-activity-list">
              <p>Loading recent activity...</p>
            </div>
          </div>

          <div class="charts-container">
            <div class="chart-card" style="--i: 6">
              <h3>Statistics Overview</h3>
              <div class="chart-wrapper">
                <canvas id="main-chart"></canvas>
              </div>
            </div>
            <div class="chart-card" style="--i: 7">
              <h3>Distribution</h3>
              <div class="chart-wrapper">
                <canvas id="pie-chart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div id="comics-section" class="section-content">
          <div class="form-card" style="--i: 1">
            <h2>Add New Comic</h2>
            <form id="comic-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="comic-title">Title</label
                  ><input
                    type="text"
                    id="comic-title"
                    class="form-control"
                    placeholder="e.g., Marvel"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="comic-author">Author</label
                  ><input
                    type="text"
                    id="comic-author"
                    class="form-control"
                    placeholder="e.g., IronMan"
                    required
                  />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="comic-folder">Cloudinary Folder Name</label
                  ><input
                    type="text"
                    id="comic-folder"
                    class="form-control"
                    placeholder="e.g., Marvel_Comics"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="comic-category">Category</label
                  ><select id="comic-category" class="form-control" required>
                    <option value="">Loading categories...</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label for="comic-tags">Tags (comma-separated)</label
                ><input
                  type="text"
                  id="comic-tags"
                  class="form-control"
                  placeholder="e.g., Action, Suspence, Thriller"
                />
              </div>
              <div class="form-group">
                <label>Thumbnail</label
                ><input
                  type="url"
                  id="comic-thumbnail"
                  class="form-control"
                  placeholder="Paste Cloudinary image URL here"
                  required
                />
              </div>
              <div class="form-group">
                <label for="comic-description">Description</label
                ><textarea
                  id="comic-description"
                  class="form-control"
                  placeholder="A brief summary of the comic..."
                ></textarea>
              </div>
              <div class="form-group">
                <label for="comic-manifest-url">Manifest JSON URL</label>
                <input
                  type="url"
                  id="comic-manifest-url"
                  class="form-control"
                  placeholder="Paste GitHub Gist Raw URL here"
                  required
                />
              </div>
              <div class="form-actions">
                <button type="reset" class="btn btn-outline">Clear</button>
                <button type="submit" id="submit-comic" class="btn btn-primary">
                  <span
                    id="submit-spinner"
                    class="loading-spinner hidden"
                  ></span
                  ><span id="submit-text">Add Comic</span>
                </button>
              </div>
            </form>
          </div>
          <div class="form-card" style="--i: 2">
            <div class="header">
              <h2>Comics Library</h2>
              <div class="form-group" style="margin-bottom: 0">
                <input
                  type="text"
                  id="search-comics"
                  class="form-control"
                  placeholder="Search comics..."
                />
              </div>
            </div>
            <div id="admin-comics-grid" class="comics-grid"></div>
          </div>
        </div>

        <div id="categories-section" class="section-content">
          <div class="form-card" style="--i: 1">
            <h2>Add New Category</h2>
            <form
              id="category-form"
              style="display: flex; gap: 1rem; align-items: center"
            >
              <div class="form-group" style="flex-grow: 1; margin-bottom: 0">
                <label for="category-name-input" class="hidden"
                  >Category Name</label
                >
                <input
                  type="text"
                  id="category-name-input"
                  class="form-control"
                  placeholder="Enter new category name (e.g., Parody)"
                  required
                />
              </div>
              <button
                type="submit"
                id="add-category-btn"
                class="btn btn-primary"
              >
                Add Category
              </button>
            </form>
          </div>
          <div class="form-card" style="--i: 2">
            <h2>Existing Categories</h2>
            <ul id="categories-list-admin" class="category-admin-list"></ul>
          </div>
        </div>

        <div id="users-section" class="section-content">
          <div class="form-card">
            <div class="card-header">
              <h2>User Management</h2>
              <div
                style="
                  display: flex;
                  gap: 1rem;
                  align-items: center;
                  flex-wrap: wrap;
                "
              >
                <div
                  class="form-group"
                  style="margin-bottom: 0; min-width: 250px; flex-grow: 1"
                >
                  <input
                    type="text"
                    id="search-clients"
                    class="form-control"
                    placeholder="Search by name or email..."
                  />
                </div>
                <button id="add-user-btn" class="btn btn-primary">
                  Add User
                </button>
              </div>
            </div>
            <div style="overflow-x: auto">
              <table class="user-table">
                <thead>
                  <tr>
                    <th>Avatar</th>
                    <th>Display Name</th>
                    <th>Email</th>
                    <th>Password</th>
                    <th>Joined Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="clients-list-body">
                  <tr>
                    <td colspan="6" style="text-align: center">
                      Loading users...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="settings-section" class="section-content">
          <div class="form-card">
            <h2>Settings</h2>
            <div class="settings-item">
              <div class="settings-item-label">
                <h3>Dark Mode</h3>
                <p>Toggle the dashboard's color scheme.</p>
              </div>
              <label class="switch">
                <input type="checkbox" id="dark-mode-toggle" />
                <span class="slider"></span>
              </label>
            </div>
            <div class="settings-item">
              <div class="settings-item-label">
                <h3>Clear Cache</h3>
                <p>Clear temporary data stored in your browser.</p>
              </div>
              <button id="clear-cache-btn" class="btn btn-outline">
                Clear
              </button>
            </div>
            <div class="settings-item">
              <div class="settings-item-label">
                <h3>Backup Data</h3>
                <p>Download a backup of your Firestore data.</p>
              </div>
              <button id="backup-data-btn" class="btn btn-outline">
                <span class="loading-spinner hidden"></span>
                <span>Backup</span>
              </button>
            </div>
            <div class="settings-item">
              <div class="settings-item-label">
                <h3>Restore Data</h3>
                <p>Restore data from a backup file.</p>
              </div>
              <button id="restore-data-btn" class="btn btn-outline">
                <span class="loading-spinner hidden"></span>
                <span>Restore</span>
              </button>
              <input
                type="file"
                id="restore-file-input"
                class="hidden"
                accept=".zip"
              />
            </div>
            <div class="settings-item">
              <div class="settings-item-label">
                <h3>Logout</h3>
                <p>Sign out of the admin dashboard.</p>
              </div>
              <button id="settings-logout-btn" class="btn btn-danger">
                Logout
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <div class="modal" id="delete-modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h3 class="modal-title">Confirm Deletion</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <p>
            Are you sure you want to delete this comic and all its parts? This
            action cannot be undone.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" id="cancel-delete">Cancel</button
          ><button class="btn btn-danger" id="confirm-delete">Delete</button>
        </div>
      </div>
    </div>

    <div class="modal" id="edit-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Edit Comic</h3>
          <button class="modal-close" id="edit-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <form id="edit-comic-form">
            <input type="hidden" id="edit-comic-id" />
            <div class="form-group">
              <label for="edit-comic-title">Title</label
              ><input
                type="text"
                id="edit-comic-title"
                class="form-control"
                required
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="edit-comic-author">Author</label
                ><input
                  type="text"
                  id="edit-comic-author"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label for="edit-comic-folder">Cloudinary Folder</label
                ><input
                  type="text"
                  id="edit-comic-folder"
                  class="form-control"
                  required
                />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="edit-comic-category">Category</label
                ><select
                  id="edit-comic-category"
                  class="form-control"
                  required
                ></select>
              </div>
              <div class="form-group">
                <label for="edit-comic-tags">Tags</label
                ><input type="text" id="edit-comic-tags" class="form-control" />
              </div>
            </div>
            <div class="form-group">
              <label for="edit-comic-thumbnail">Thumbnail URL</label
              ><input
                type="url"
                id="edit-comic-thumbnail"
                class="form-control"
                required
              />
            </div>
            <div class="form-group">
              <label for="edit-comic-description">Description</label
              ><textarea
                id="edit-comic-description"
                class="form-control"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="edit-comic-manifest-url">Manifest JSON URL</label>
              <input
                type="url"
                id="edit-comic-manifest-url"
                class="form-control"
                required
              />
            </div>
            <div class="parts-management-section">
              <h4
                style="
                  margin-top: 1.5rem;
                  border-top: 1px solid var(--border-color);
                  padding-top: 1.5rem;
                "
              >
                Part Name Overrides
              </h4>
              <div id="part-overrides-container" style="margin-top: 1rem"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-danger"
            id="delete-from-modal-btn"
            style="margin-right: auto"
          >
            Delete Comic
          </button>
          <button type="button" class="btn btn-outline" id="cancel-edit">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" id="save-edit">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="pfp-modal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <h3 class="modal-title">Change Profile Picture</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <h4>Select a Preset Avatar</h4>
          <div id="preset-avatars-grid" class="preset-avatars-grid"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" id="cancel-pfp-change">Cancel</button>
          <button class="btn btn-primary hidden" id="save-pfp-btn">
            <span class="loading-spinner hidden"></span>
            <span>Save Changes</span>
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="delete-client-modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h3 class="modal-title">Confirm User Deletion</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <p>
            Are you sure you want to delete this user's data from the database?
            This action cannot be undone.
          </p>
          <p
            style="font-size: 0.8rem; color: var(--text-gray); margin-top: 1rem"
          >
            <strong>Note:</strong> This only removes the Firestore document. For
            full deletion, the user must be removed from Firebase Authentication
            via a backend function.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" id="cancel-delete-client">
            Cancel
          </button>
          <button class="btn btn-danger" id="confirm-delete-client">
            Delete User Data
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="delete-all-activities-modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h3 class="modal-title">Confirm Clear All Activity</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <p>
            Are you sure you want to delete <strong>all</strong> activity logs?
            This action is permanent and cannot be undone.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" id="cancel-delete-all-activities">
            Cancel
          </button>
          <button class="btn btn-danger" id="confirm-delete-all-activities">
            Yes, Delete All
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="restore-confirm-modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h3 class="modal-title">Confirm Data Restore</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <p style="color: var(--error); font-weight: bold">Warning!</p>
          <p>
            Restoring from a backup will
            <strong
              >permanently delete all existing comics, categories, and
              settings</strong
            >
            before importing the new data. This action cannot be undone.
          </p>
          <p style="margin-top: 1rem">Are you sure you want to proceed?</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" id="cancel-restore">Cancel</button>
          <button class="btn btn-danger" id="confirm-restore">
            Yes, Restore Data
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="clear-cache-modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h3 class="modal-title">Confirm Clear Cache</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <p>
            Are you sure you want to clear the browser cache for this
            application?
          </p>
          <p
            style="
              margin-top: 1rem;
              font-size: 0.875rem;
              color: var(--text-gray);
            "
          >
            This will remove locally stored settings, such as your preferred
            theme (light/dark mode). You will not be logged out.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" id="cancel-clear-cache">
            Cancel
          </button>
          <button class="btn btn-warning" id="confirm-clear-cache">
            Yes, Clear Cache
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="add-user-modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h3 class="modal-title">Add New User</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <form id="add-user-form">
            <div class="form-group">
              <label for="new-user-name">Display Name</label>
              <input
                type="text"
                id="new-user-name"
                class="form-control"
                required
              />
            </div>
            <div class="form-group">
              <label for="new-user-email">Email</label>
              <input
                type="email"
                id="new-user-email"
                class="form-control"
                required
              />
            </div>
            <div class="form-group">
              <label for="new-user-password">Password</label>
              <input
                type="text"
                id="new-user-password"
                class="form-control"
                required
              />
            </div>
          </form>
          <p style="font-size: 0.8rem; color: var(--warning); margin-top: 1rem">
            <strong>Security Warning:</strong> This method adds a user record to
            the database with a plain-text password and does NOT create a real
            authentication account. This user will NOT be able to log in. This
            is for data-entry purposes only.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" id="cancel-add-user">Cancel</button>
          <button class="btn btn-primary" id="confirm-add-user">
            Add User
          </button>
        </div>
      </div>
    </div>

    <script>
      // =================================================================
      // =================  Firebase Configuration  ====================
      // =================================================================
      const firebaseConfig = {
        apiKey: "AIzaSyCwkRk12HxQlQS2DH12lcolRNvF2ALprZM",
        authDomain: "comix-9be69.firebaseapp.com",
        projectId: "comix-9be69",
        storageBucket: "comix-9be69.appspot.com",
        messagingSenderId: "346083786632",
        appId: "1:346083786632:web:f95c8c3dacafe47f23843d",
      };

      // Firebase services ko initialize karein
      let app;
      if (!firebase.apps.length) {
        app = firebase.initializeApp(firebaseConfig);
      } else {
        app = firebase.app();
      }

      const auth = firebase.auth();
      const db = firebase.firestore();
      const storage = firebase.storage();

      // =================================================================
      // =====================  Global Variables  ======================
      // =================================================================
      let currentComicToDelete = null;
      let currentComicToEdit = null;
      let allComics = [];
      let allClients = [];
      let currentClientToDelete = null;
      let unsubscribeComics = null;
      let selectedPfpUrl = null;
      let dataToRestore = null;
      let mainChart = null;
      let pieChart = null;

      // =================================================================
      // ===================  DOM Element Selectors  ===================
      // =================================================================
      const authContainer = document.getElementById("auth-container");
      const adminDashboard = document.getElementById("admin-dashboard");
      const loginBtn = document.getElementById("login-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const comicForm = document.getElementById("comic-form");
      const comicsGrid = document.getElementById("admin-comics-grid");
      const searchInput = document.getElementById("search-comics");
      const deleteModal = document.getElementById("delete-modal");
      const editModal = document.getElementById("edit-modal");
      const toastContainer = document.getElementById("toast-container");
      const themeToggleBtn = document.getElementById("theme-toggle-btn");
      const userProfileImg = document.getElementById("user-profile-img");
      const pfpModal = document.getElementById("pfp-modal");
      const presetAvatarsGrid = document.getElementById("preset-avatars-grid");
      const savePfpBtn = document.getElementById("save-pfp-btn");
      const deleteAllActivitiesBtn = document.getElementById(
        "delete-all-activities-btn"
      );
      const recentActivityList = document.getElementById(
        "recent-activity-list"
      );
      const darkModeToggle = document.getElementById("dark-mode-toggle");
      const backupBtn = document.getElementById("backup-data-btn");
      const restoreBtn = document.getElementById("restore-data-btn");
      const restoreFileInput = document.getElementById("restore-file-input");
      const totalComicsEl = document.getElementById("total-comics");
      const activeUsersEl = document.getElementById("active-users");
      const pageViewsEl = document.getElementById("page-views");
      const comicCategorySelect = document.getElementById("comic-category");
      const editComicCategorySelect = document.getElementById(
        "edit-comic-category"
      );
      const mobileMenuBtn = document.getElementById("mobile-menu-btn");
      const sidebar = document.getElementById("sidebar");
      const sidebarOverlay = document.getElementById("sidebar-overlay");
      const deleteAllActivitiesModal = document.getElementById(
        "delete-all-activities-modal"
      );
      const searchClientsInput = document.getElementById("search-clients");
      const clientsListBody = document.getElementById("clients-list-body");
      const deleteClientModal = document.getElementById("delete-client-modal");
      const restoreConfirmModal = document.getElementById(
        "restore-confirm-modal"
      );
      const addUserBtn = document.getElementById("add-user-btn");
      const addUserModal = document.getElementById("add-user-modal");
      const clearCacheBtn = document.getElementById("clear-cache-btn");
      const clearCacheModal = document.getElementById("clear-cache-modal");

      const sectionContents = {
        dashboard: document.getElementById("dashboard-section"),
        comics: document.getElementById("comics-section"),
        categories: document.getElementById("categories-section"),
        users: document.getElementById("users-section"),
        settings: document.getElementById("settings-section"),
      };

      const presetAvatars = [
        { style: "adventurer", seed: "Midnight" },
        { style: "adventurer", seed: "Snowball" },
        { style: "adventurer", seed: "Patches" },
        { style: "adventurer", seed: "Sheba" },
        { style: "pixel-art", seed: "Max" },
        { style: "pixel-art", seed: "Lucy" },
        { style: "pixel-art", seed: "Charlie" },
        { style: "pixel-art", seed: "Daisy" },
        { style: "fun-emoji", seed: "Happy" },
        { style: "fun-emoji", seed: "Sad" },
        { style: "fun-emoji", seed: "Winking" },
        { style: "fun-emoji", seed: "Cool" },
        { style: "fun-emoji", seed: "Love" },
        { style: "fun-emoji", seed: "LOL" },
        { style: "fun-emoji", seed: "Surprised" },
        { style: "fun-emoji", seed: "Angry" },
        { style: "bottts", seed: "Gizmo" },
        { style: "bottts", seed: "Sparky" },
        { style: "bottts", seed: "Clank" },
        { style: "bottts", seed: "Bolt" },
        { style: "micah", seed: "Leo" },
        { style: "micah", seed: "Mia" },
        { style: "micah", seed: "Zoe" },
        { style: "micah", seed: "Sam" },
        { style: "initials", seed: "Admin" },
        { style: "initials", seed: "User" },
        { style: "initials", seed: "Guest" },
        { style: "initials", seed: "Panel" },
        { style: "lorelei", seed: "Luna" },
        { style: "lorelei", seed: "Oliver" },
        { style: "lorelei", seed: "Bella" },
        { style: "lorelei", seed: "Jasper" },
        { style: "shapes", seed: "Circle" },
        { style: "shapes", seed: "Square" },
        { style: "shapes", seed: "Triangle" },
        { style: "shapes", seed: "Diamond" },
        { style: "thumbs", seed: "Up" },
        { style: "thumbs", seed: "Down" },
        { style: "thumbs", seed: "Cool" },
        { style: "thumbs", seed: "Awesome" },
        { style: "avataaars", seed: "Felix" },
        { style: "avataaars", seed: "Milo" },
        { style: "avataaars", seed: "Cleo" },
        { style: "avataaars", seed: "Rocky" },
        { style: "big-ears", seed: "Simba" },
        { style: "big-ears", seed: "Nala" },
        { style: "big-ears", seed: "Coco" },
        { style: "big-ears", seed: "Oreo" },
      ];

      // =================================================================
      // =====================  Helper Functions  ======================
      // =================================================================

      const toggleButtonLoading = (btn, isLoading) => {
        if (!btn) return;
        const spinner = btn.querySelector(".loading-spinner");
        const textSpan = btn.querySelector("span:not(.loading-spinner)");
        btn.disabled = isLoading;
        if (spinner) spinner.classList.toggle("hidden", !isLoading);
        if (textSpan) textSpan.classList.toggle("hidden", isLoading);
      };

      const applyInitialTheme = () => {
        const theme = localStorage.getItem("theme") || "light";
        setTheme(theme);
      };

      const setTheme = (theme) => {
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem("theme", theme);
        if (themeToggleBtn) {
          themeToggleBtn.innerHTML = `<i class="fas ${
            theme === "dark" ? "fa-sun" : "fa-moon"
          }"></i>`;
        }
        if (darkModeToggle) {
          darkModeToggle.checked = theme === "dark";
        }
      };

      const showSection = (sectionKey) => {
        document
          .querySelectorAll(".menu-item")
          .forEach((item) =>
            item.classList.toggle("active", item.dataset.section === sectionKey)
          );
        Object.values(sectionContents).forEach((el) =>
          el.classList.remove("is-active")
        );
        const sectionToShow = sectionContents[sectionKey];
        if (sectionToShow) {
          sectionToShow.classList.add("is-active");
        }
        document.getElementById("section-title").textContent =
          sectionKey.charAt(0).toUpperCase() + sectionKey.slice(1);
      };

      const showToast = (type, title, message) => {
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        const icons = {
          success: "fa-check-circle",
          error: "fa-exclamation-circle",
          warning: "fa-exclamation-triangle",
        };
        toast.innerHTML = `<div class="toast-icon"><i class="fas ${icons[type]}"></i></div><div><div class="toast-title">${title}</div><div class="toast-message">${message}</div></div><button class="toast-close">&times;</button>`;
        toastContainer.appendChild(toast);
        const timer = setTimeout(() => {
          toast.classList.add("hide");
          setTimeout(() => toast.remove(), 400);
        }, 5000);
        toast.querySelector(".toast-close").onclick = () => {
          clearTimeout(timer);
          toast.classList.add("hide");
          setTimeout(() => toast.remove(), 400);
        };
      };

      function clearBrowserCache() {
        const confirmBtn = document.getElementById("confirm-clear-cache");
        toggleButtonLoading(confirmBtn, true);
        try {
          // Specifically remove the theme to avoid clearing Firebase auth keys from localStorage.
          localStorage.removeItem("theme");
          console.log('Cleared "theme" from localStorage.');

          // Re-apply the default theme visually.
          applyInitialTheme();

          showToast(
            "success",
            "Cache Cleared",
            "Local theme setting has been reset."
          );
          logActivity("Settings", "Cleared browser cache (theme setting).");
        } catch (error) {
          console.error("Error clearing cache:", error);
          showToast("error", "Error", "Could not clear browser cache.");
        } finally {
          toggleButtonLoading(confirmBtn, false);
          document.getElementById("clear-cache-modal").classList.remove("show");
        }
      }

      // =================================================================
      // ====================  Firebase Functions  =====================
      // =================================================================

      async function logActivity(action, details) {
        try {
          const user = auth.currentUser;
          await db.collection("activity_log").add({
            action: action,
            details: details,
            userEmail: user ? user.email : "Unknown",
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          });
        } catch (error) {
          console.error("Error logging activity:", error);
        }
      }

      function formatTimeAgo(timestamp) {
        if (!timestamp) return "Just now";
        const now = new Date();
        const seconds = Math.floor((now - timestamp.toDate()) / 1000);
        if (seconds < 5) return "Just now";
        const intervals = {
          year: 31536000,
          month: 2592000,
          day: 86400,
          hour: 3600,
          minute: 60,
        };
        for (let unit in intervals) {
          let interval = seconds / intervals[unit];
          if (interval > 1) {
            const value = Math.floor(interval);
            return `${value} ${unit}${value > 1 ? "s" : ""} ago`;
          }
        }
        return Math.floor(seconds) + " seconds ago";
      }

      function loadRecentActivity() {
        db.collection("activity_log")
          .orderBy("timestamp", "desc")
          .limit(30)
          .onSnapshot(
            (snapshot) => {
              if (snapshot.empty) {
                recentActivityList.innerHTML =
                  "<p>No recent activity found.</p>";
                return;
              }
              let activityHtml = '<ul class="activity-list">';
              snapshot.forEach((doc) => {
                const activity = doc.data();
                const docId = doc.id;
                let icon = "fa-plus-circle";
                if (activity.action.includes("Edited")) icon = "fa-pencil-alt";
                if (activity.action.includes("Deleted")) icon = "fa-trash-alt";
                if (activity.action.includes("Category")) icon = "fa-tags";
                activityHtml += `
                <li class="activity-item">
                    <i class="fas ${icon}" style="margin-right: 12px; color: var(--text-gray);"></i>
                    <div class="activity-details">
                        <strong>${activity.action}:</strong> ${activity.details}
                    </div>
                    <div class="activity-time">${formatTimeAgo(
                      activity.timestamp
                    )}</div>
                    <button class="delete-activity-btn" data-id="${docId}" title="Delete Activity"><i class="fas fa-trash"></i></button>
                </li>`;
              });
              activityHtml += "</ul>";
              recentActivityList.innerHTML = activityHtml;
            },
            (err) => {
              console.error("Error loading activity:", err);
              showToast(
                "error",
                "Activity Error",
                "Could not load activity log. Check permissions."
              );
              recentActivityList.innerHTML =
                '<p style="color:red;">Could not load activity.</p>';
            }
          );
      }

      function renderClientsTable(clientsArray) {
        if (!clientsListBody) return;
        if (clientsArray.length === 0) {
          clientsListBody.innerHTML =
            '<tr><td colspan="6" style="text-align: center;">No users match your search.</td></tr>';
          return;
        }

        let usersHtml = "";
        clientsArray.forEach((user) => {
          const joinedDate = user.createdAt
            ? user.createdAt.toDate().toLocaleDateString()
            : "N/A";
          usersHtml += `
                        <tr>
                            <td><img src="${
                              user.avatarUrl || "https://via.placeholder.com/40"
                            }" alt="${
            user.displayName
          }" class="user-avatar"></td>
                            <td>${user.displayName || "N/A"}</td>
                            <td>${user.email || "N/A"}</td>
                            <td>${user.password || "********"}</td>
                            <td>${joinedDate}</td>
                            <td>
                                <button class="btn btn-xs btn-danger delete-client-btn" data-id="${
                                  user.id
                                }" title="Delete User Data">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
        });
        clientsListBody.innerHTML = usersHtml;
      }

      function loadClientsData() {
        db.collection("clients")
          .orderBy("createdAt", "desc")
          .onSnapshot(
            (snapshot) => {
              const userCount = snapshot.size;
              if (activeUsersEl) activeUsersEl.textContent = userCount;
              updateChartData();

              allClients = snapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));

              if (snapshot.empty) {
                clientsListBody.innerHTML =
                  '<tr><td colspan="6" style="text-align: center;">No users found.</td></tr>';
                return;
              }

              renderClientsTable(allClients);
            },
            (err) => {
              console.error("Error loading clients:", err);
              showToast("error", "Error", "Could not load user data.");
              clientsListBody.innerHTML =
                '<tr><td colspan="6" style="color:red; text-align: center;">Error loading users. Check permissions.</td></tr>';
            }
          );
      }

      async function deleteClient() {
        if (!currentClientToDelete) return;
        const userId = currentClientToDelete.id;
        const userEmail = currentClientToDelete.email;

        try {
          await db.collection("clients").doc(userId).delete();
          await logActivity(
            "User Data Deleted",
            `Deleted data for ${userEmail}`
          );
          showToast(
            "success",
            "User Data Deleted",
            `Removed ${userEmail}'s data from the database.`
          );
        } catch (err) {
          showToast("error", "Deletion Failed", err.message);
          console.error("Error deleting client data:", err);
        } finally {
          currentClientToDelete = null;
          if (deleteClientModal) deleteClientModal.classList.remove("show");
        }
      }

      async function addNewClient(e) {
        e.preventDefault();
        const name = document.getElementById("new-user-name").value;
        const email = document.getElementById("new-user-email").value;
        const password = document.getElementById("new-user-password").value;

        if (!name || !email || !password) {
          showToast("error", "Missing Fields", "Please fill out all fields.");
          return;
        }

        const confirmBtn = document.getElementById("confirm-add-user");
        toggleButtonLoading(confirmBtn, true);

        try {
          await db.collection("clients").add({
            displayName: name,
            email: email,
            password: password,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            avatarUrl: `https://api.dicebear.com/8.x/initials/svg?seed=${name}`,
            favorites: [],
          });

          await logActivity(
            "User Added (Admin)",
            `Created record for ${email}`
          );
          showToast(
            "success",
            "User Record Added",
            `A database record for ${email} has been created.`
          );
          addUserModal.classList.remove("show");
          document.getElementById("add-user-form").reset();
        } catch (err) {
          showToast("error", "Error", "Could not add user record.");
          console.error("Error adding new client:", err);
        } finally {
          toggleButtonLoading(confirmBtn, false);
        }
      }

      async function deleteAllActivities() {
        const confirmBtn = document.getElementById(
          "confirm-delete-all-activities"
        );
        toggleButtonLoading(confirmBtn, true);
        try {
          const snapshot = await db.collection("activity_log").get();
          if (snapshot.empty) {
            showToast(
              "warning",
              "No Logs",
              "There are no activity logs to delete."
            );
            return;
          }

          const batch = db.batch();
          snapshot.docs.forEach((doc) => {
            batch.delete(doc.ref);
          });

          await batch.commit();

          showToast(
            "success",
            "All Logs Deleted",
            "The activity log has been cleared."
          );
        } catch (err) {
          showToast(
            "error",
            "Deletion Failed",
            "Could not delete all activity logs."
          );
          console.error("Error deleting all activities:", err);
        } finally {
          toggleButtonLoading(confirmBtn, false);
          if (deleteAllActivitiesModal) {
            deleteAllActivitiesModal.classList.remove("show");
          }
        }
      }

      async function adminLogin() {
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        const errorEl = document.getElementById("login-error");
        errorEl.textContent = "";
        toggleButtonLoading(loginBtn, true);
        try {
          await auth.signInWithEmailAndPassword(email, password);
        } catch (err) {
          errorEl.textContent = "Invalid credentials. Please try again.";
          showToast("error", "Login Failed", err.message);
        } finally {
          toggleButtonLoading(loginBtn, false);
        }
      }

      async function handleComicSubmit(e) {
        e.preventDefault();
        const submitBtn = document.getElementById("submit-comic");
        toggleButtonLoading(submitBtn, true);
        const comicData = {
          title: document.getElementById("comic-title").value,
          author: document.getElementById("comic-author").value,
          folderName: document.getElementById("comic-folder").value,
          category: document.getElementById("comic-category").value,
          tags: document
            .getElementById("comic-tags")
            .value.split(",")
            .map((t) => t.trim())
            .filter(Boolean),
          description: document.getElementById("comic-description").value,
          thumbnailUrl: document.getElementById("comic-thumbnail").value,
          manifestUrl: document.getElementById("comic-manifest-url").value,
          totalViews: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        };
        if (
          !comicData.title ||
          !comicData.thumbnailUrl ||
          !comicData.manifestUrl
        ) {
          showToast(
            "error",
            "Validation Error",
            "Title, Thumbnail, and Manifest URL are required."
          );
          toggleButtonLoading(submitBtn, false);
          return;
        }
        try {
          await db.collection("comics").add(comicData);
          await logActivity("Comic Added", comicData.title);
          showToast("success", "Success!", "Comic added successfully.");
          comicForm.reset();
        } catch (err) {
          showToast("error", "Error", `Failed to add comic: ${err.message}`);
        } finally {
          toggleButtonLoading(submitBtn, false);
        }
      }

      async function openEditModal(comic) {
        currentComicToEdit = comic;
        document.getElementById("edit-comic-id").value = comic.id;
        document.getElementById("edit-comic-title").value = comic.title;
        document.getElementById("edit-comic-author").value = comic.author || "";
        document.getElementById("edit-comic-folder").value = comic.folderName;
        document.getElementById("edit-comic-category").value =
          comic.category || "";
        document.getElementById("edit-comic-tags").value =
          comic.tags?.join(", ") || "";
        document.getElementById("edit-comic-thumbnail").value =
          comic.thumbnailUrl;
        document.getElementById("edit-comic-description").value =
          comic.description || "";
        document.getElementById("edit-comic-manifest-url").value =
          comic.manifestUrl || "";
        editModal.classList.add("show");

        const overridesContainer = document.getElementById(
          "part-overrides-container"
        );
        overridesContainer.innerHTML = "Loading parts...";

        if (comic.manifestUrl) {
          try {
            const response = await fetch(comic.manifestUrl);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const manifestData = await response.json();
            const parts = manifestData.parts;

            if (Array.isArray(parts) && parts.length > 0) {
              overridesContainer.innerHTML = "";
              parts.forEach((part, index) => {
                const overrideValue =
                  comic.partNameOverrides && comic.partNameOverrides[index]
                    ? comic.partNameOverrides[index]
                    : "";

                const formGroup = document.createElement("div");
                formGroup.className = "form-group";
                formGroup.style.marginBottom = "0.75rem";

                const input = document.createElement("input");
                input.type = "text";
                input.className = "form-control";
                input.placeholder = `Part ${index + 1} Name (Default: ${
                  comic.title
                } - Part ${index + 1})`;
                input.dataset.index = index;
                input.value = overrideValue;

                formGroup.appendChild(input);
                overridesContainer.appendChild(formGroup);
              });
            } else {
              overridesContainer.innerHTML =
                '<p style="color: var(--text-gray);">No parts found in manifest or manifest is not a valid array.</p>';
            }
          } catch (err) {
            console.error("Failed to fetch or parse comic manifest:", err);
            overridesContainer.innerHTML =
              '<p style="color: var(--error);">Could not load parts from manifest URL. Please check the URL and its content.</p>';
          }
        } else {
          overridesContainer.innerHTML =
            '<p style="color: var(--text-gray);">No manifest URL provided.</p>';
        }
      }

      async function saveComicEdit() {
        if (!currentComicToEdit) return;
        const saveBtn = document.getElementById("save-edit");
        toggleButtonLoading(saveBtn, true);
        const comicId = currentComicToEdit.id;

        const partNameOverrides = {};
        const overrideInputs = document.querySelectorAll(
          "#part-overrides-container .form-control"
        );
        overrideInputs.forEach((input) => {
          const index = input.dataset.index;
          const value = input.value.trim();
          if (value) {
            partNameOverrides[index] = value;
          }
        });

        const updatedData = {
          title: document.getElementById("edit-comic-title").value,
          author: document.getElementById("edit-comic-author").value,
          folderName: document.getElementById("edit-comic-folder").value,
          category: document.getElementById("edit-comic-category").value,
          tags: document
            .getElementById("edit-comic-tags")
            .value.split(",")
            .map((t) => t.trim())
            .filter(Boolean),
          description: document.getElementById("edit-comic-description").value,
          thumbnailUrl: document.getElementById("edit-comic-thumbnail").value,
          manifestUrl: document.getElementById("edit-comic-manifest-url").value,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          partNameOverrides: partNameOverrides,
        };
        try {
          await db.collection("comics").doc(comicId).update(updatedData);
          await logActivity("Comic Edited", updatedData.title);
          showToast("success", "Updated!", "Comic details saved.");
          editModal.classList.remove("show");
        } catch (err) {
          showToast("error", "Save Failed", err.message);
        } finally {
          toggleButtonLoading(saveBtn, false);
          currentComicToEdit = null;
        }
      }

      async function deleteComic() {
        if (!currentComicToDelete) return;
        const { id: comicId, title: comicTitle } = currentComicToDelete;
        try {
          await db.collection("comics").doc(comicId).delete();
          await logActivity("Comic Deleted", comicTitle);
          showToast("success", "Deleted", `Comic "${comicTitle}" removed.`);
          deleteModal.classList.remove("show");
          currentComicToDelete = null;
        } catch (err) {
          showToast("error", "Error", "Failed to delete comic.");
        }
      }

      function setupComicsListener() {
        if (unsubscribeComics) unsubscribeComics();
        unsubscribeComics = db
          .collection("comics")
          .orderBy("createdAt", "desc")
          .onSnapshot(
            (snapshot) => {
              allComics = snapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
              renderAllComics(allComics);

              const comicCount = snapshot.size;
              const viewCount = allComics.reduce(
                (sum, comic) => sum + (comic.totalViews || 0),
                0
              );

              if (totalComicsEl) totalComicsEl.textContent = comicCount;
              if (pageViewsEl) pageViewsEl.textContent = viewCount;

              updateChartData();
            },
            (err) => {
              console.error("Error loading comics:", err);
              showToast(
                "error",
                "Comics Error",
                "Failed to load comics. Check permissions."
              );
            }
          );
      }

      function renderAllComics(comicsArray) {
        if (!comicsGrid) return;
        comicsGrid.innerHTML = "";
        if (comicsArray.length === 0) {
          comicsGrid.innerHTML = `<p style="color: var(--text-gray); grid-column: 1 / -1;">No comics found.</p>`;
          return;
        }
        comicsArray.forEach((comic, index) => {
          const card = document.createElement("div");
          card.className = "comic-card";
          card.style.setProperty("--i", index);
          card.innerHTML = `
                <div class="image-container">
                    <img src="${comic.thumbnailUrl}" alt="${
            comic.title
          }" loading="lazy" onerror="this.onerror=null; this.src='https://via.placeholder.com/160x240?text=No+Image';">
                </div>
                <div class="comic-body">
                    <h3 class="comic-title" title="${comic.title}">${
            comic.title
          }</h3>
                    <p class="comic-author">${comic.author || "N/A"}</p>
                </div>`;
          card.addEventListener("click", () => openEditModal(comic));
          comicsGrid.appendChild(card);
        });
      }

      function loadAdminCategories() {
        db.collection("categories")
          .orderBy("name")
          .onSnapshot((snapshot) => {
            const listEl = document.getElementById("categories-list-admin");
            if (!listEl) return;
            listEl.innerHTML = "";
            snapshot.forEach((doc, i) => {
              const cat = { id: doc.id, ...doc.data() };
              const item = document.createElement("li");
              item.className = "category-admin-item";
              item.style.setProperty("--i", i);
              item.innerHTML = `<span>${cat.name}</span><button class="btn btn-xs btn-danger">Delete</button>`;
              item.querySelector("button").onclick = async () => {
                await db.collection("categories").doc(cat.id).delete();
                await logActivity("Category Deleted", cat.name);
                showToast(
                  "success",
                  "Deleted",
                  `Category "${cat.name}" removed.`
                );
              };
              listEl.appendChild(item);
            });
          });
      }

      function loadCategoriesIntoSelects() {
        db.collection("categories")
          .orderBy("name")
          .onSnapshot((snapshot) => {
            let optionsHtml =
              '<option value="" disabled selected>Select a Category</option>';
            snapshot.forEach(
              (doc) =>
                (optionsHtml += `<option value="${doc.data().value}">${
                  doc.data().name
                }</option>`)
            );
            if (comicCategorySelect)
              comicCategorySelect.innerHTML = optionsHtml;
            if (editComicCategorySelect)
              editComicCategorySelect.innerHTML = optionsHtml;
          });
      }

      async function loadAdminProfile() {
        try {
          const doc = await db
            .collection("settings")
            .doc("admin_profile")
            .get();
          if (doc.exists && doc.data().profilePictureUrl) {
            userProfileImg.src = doc.data().profilePictureUrl;
          }
        } catch (error) {
          console.error("Could not load admin profile:", error);
          showToast("error", "Profile Error", "Could not load admin profile.");
        }
      }

      function populatePresetAvatars() {
        if (!presetAvatarsGrid) return;
        presetAvatarsGrid.innerHTML = "";
        presetAvatars.forEach((avatar) => {
          const url = `https://api.dicebear.com/8.x/${avatar.style}/svg?seed=${avatar.seed}`;
          const img = document.createElement("img");
          img.src = url;
          img.alt = `${avatar.style} - ${avatar.seed}`;
          img.className = "preset-avatar";
          img.dataset.url = url;
          presetAvatarsGrid.appendChild(img);
        });
      }

      async function savePfpChange() {
        if (!selectedPfpUrl) {
          showToast(
            "warning",
            "No Selection",
            "Please select an avatar first."
          );
          return;
        }
        toggleButtonLoading(savePfpBtn, true);
        try {
          await db.collection("settings").doc("admin_profile").set(
            {
              profilePictureUrl: selectedPfpUrl,
            },
            { merge: true }
          );

          userProfileImg.src = selectedPfpUrl;
          await logActivity("Admin Profile", "Updated profile picture.");
          showToast(
            "success",
            "Avatar Updated",
            "Your new profile picture has been saved."
          );
          pfpModal.classList.remove("show");
        } catch (err) {
          showToast("error", "Update Failed", "Could not save the new avatar.");
          console.error("Error saving PFP:", err);
        } finally {
          toggleButtonLoading(savePfpBtn, false);
        }
      }

      async function backupData() {
        toggleButtonLoading(backupBtn, true);
        try {
          const collectionsToBackup = ["comics", "categories", "settings"];
          const backupObject = {};

          for (const collectionName of collectionsToBackup) {
            const snapshot = await db.collection(collectionName).get();
            backupObject[collectionName] = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
          }

          const zip = new JSZip();
          zip.file("data.json", JSON.stringify(backupObject, null, 2));

          const content = await zip.generateAsync({ type: "blob" });

          const link = document.createElement("a");
          link.href = URL.createObjectURL(content);
          const date = new Date().toISOString().slice(0, 10);
          link.download = `comixall-backup-${date}.zip`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          showToast("success", "Backup Complete", "Data has been downloaded.");
        } catch (err) {
          showToast(
            "error",
            "Backup Failed",
            "Could not generate backup file."
          );
          console.error("Backup error:", err);
        } finally {
          toggleButtonLoading(backupBtn, false);
        }
      }

      async function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        toggleButtonLoading(restoreBtn, true);

        try {
          const zip = await JSZip.loadAsync(file);
          const dataFile = zip.file("data.json");
          if (!dataFile) {
            throw new Error("data.json not found in zip file.");
          }
          const content = await dataFile.async("string");
          dataToRestore = JSON.parse(content);

          if (restoreConfirmModal) {
            restoreConfirmModal.classList.add("show");
          }
        } catch (err) {
          showToast("error", "Invalid File", "Could not read the backup file.");
          console.error("Restore file read error:", err);
        } finally {
          toggleButtonLoading(restoreBtn, false);
          event.target.value = "";
        }
      }

      async function restoreData() {
        if (!dataToRestore) {
          showToast(
            "error",
            "No Data",
            "No data was loaded from the backup file."
          );
          return;
        }

        const confirmBtn = document.getElementById("confirm-restore");
        toggleButtonLoading(confirmBtn, true);

        try {
          const collections = Object.keys(dataToRestore);

          for (const collectionName of collections) {
            const snapshot = await db.collection(collectionName).get();
            if (!snapshot.empty) {
              const batch = db.batch();
              snapshot.docs.forEach((doc) => batch.delete(doc.ref));
              await batch.commit();
            }
          }

          for (const collectionName of collections) {
            const items = dataToRestore[collectionName];
            if (items && items.length > 0) {
              const batch = db.batch();
              items.forEach((item) => {
                const docRef = db.collection(collectionName).doc(item.id);
                const { id, ...data } = item;
                batch.set(docRef, data);
              });
              await batch.commit();
            }
          }

          await logActivity("Data Restore", "Restored data from backup file.");
          showToast(
            "success",
            "Restore Complete",
            "All data has been restored successfully."
          );
        } catch (err) {
          showToast(
            "error",
            "Restore Failed",
            "An error occurred during the restore process."
          );
          console.error("Restore write error:", err);
        } finally {
          toggleButtonLoading(confirmBtn, false);
          dataToRestore = null;
          if (restoreConfirmModal) {
            restoreConfirmModal.classList.remove("show");
          }
        }
      }

      function initializeCharts() {
        const mainCtx = document.getElementById("main-chart").getContext("2d");
        const pieCtx = document.getElementById("pie-chart").getContext("2d");

        const commonOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: getComputedStyle(
                  document.documentElement
                ).getPropertyValue("--text-dark"),
              },
            },
          },
        };

        mainChart = new Chart(mainCtx, {
          type: "bar",
          data: {
            labels: ["Comics", "Users", "Views"],
            datasets: [
              {
                label: "Total Count",
                data: [0, 0, 0],
                backgroundColor: [
                  "rgba(74, 85, 162, 0.6)",
                  "rgba(56, 161, 105, 0.6)",
                  "rgba(221, 107, 32, 0.6)",
                ],
                borderColor: [
                  "rgba(74, 85, 162, 1)",
                  "rgba(56, 161, 105, 1)",
                  "rgba(221, 107, 32, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            ...commonOptions,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: getComputedStyle(
                    document.documentElement
                  ).getPropertyValue("--text-dark"),
                },
              },
              x: {
                ticks: {
                  color: getComputedStyle(
                    document.documentElement
                  ).getPropertyValue("--text-dark"),
                },
              },
            },
          },
        });

        pieChart = new Chart(pieCtx, {
          type: "doughnut",
          data: {
            labels: ["Comics", "Users", "Views"],
            datasets: [
              {
                label: "Distribution",
                data: [0, 0, 0],
                backgroundColor: [
                  "rgba(74, 85, 162, 0.8)",
                  "rgba(56, 161, 105, 0.8)",
                  "rgba(221, 107, 32, 0.8)",
                ],
                hoverOffset: 4,
              },
            ],
          },
          options: commonOptions,
        });
      }

      function updateChartData() {
        if (!mainChart || !pieChart) return;

        const comics = parseInt(totalComicsEl.textContent) || 0;
        const users = parseInt(activeUsersEl.textContent) || 0;
        const views = parseInt(pageViewsEl.textContent) || 0;

        const newData = [comics, users, views];

        mainChart.data.datasets[0].data = newData;
        pieChart.data.datasets[0].data = newData;

        mainChart.update();
        pieChart.update();
      }

      // =================================================================
      // ====================  Main App Execution  =====================
      // =================================================================

      document.addEventListener("DOMContentLoaded", () => {
        applyInitialTheme();
        populatePresetAvatars();
        initializeCharts();

        auth.onAuthStateChanged(async (user) => {
          if (user) {
            await user.getIdToken(true);
            const idTokenResult = await user.getIdTokenResult();

            if (idTokenResult.claims.admin === true) {
              authContainer.classList.add("hidden");
              adminDashboard.classList.remove("hidden");

              setupComicsListener();
              loadAdminCategories();
              loadCategoriesIntoSelects();
              loadRecentActivity();
              loadAdminProfile();
              loadClientsData();
              showSection("dashboard");
            } else {
              console.error("❌ Admin claim NOT found. Access denied.");
              showToast(
                "error",
                "Access Denied",
                "You do not have admin privileges."
              );
              await auth.signOut();
            }
          } else {
            adminDashboard.classList.add("hidden");
            authContainer.classList.remove("hidden");
            if (unsubscribeComics) {
              unsubscribeComics();
            }
          }
        });

        // =================================================================
        // =====================  Event Listeners  =======================
        // =================================================================

        if (loginBtn) loginBtn.addEventListener("click", adminLogin);
        if (logoutBtn)
          logoutBtn.addEventListener("click", () => auth.signOut());

        document
          .querySelectorAll(".menu-item")
          .forEach((item) =>
            item.addEventListener("click", (e) =>
              showSection(e.currentTarget.dataset.section)
            )
          );

        if (comicForm) comicForm.addEventListener("submit", handleComicSubmit);

        if (document.getElementById("save-edit"))
          document
            .getElementById("save-edit")
            .addEventListener("click", saveComicEdit);
        if (document.getElementById("cancel-edit"))
          document
            .getElementById("cancel-edit")
            .addEventListener("click", () =>
              editModal.classList.remove("show")
            );
        if (document.getElementById("edit-modal-close"))
          document
            .getElementById("edit-modal-close")
            .addEventListener("click", () =>
              editModal.classList.remove("show")
            );

        if (document.getElementById("delete-from-modal-btn")) {
          document
            .getElementById("delete-from-modal-btn")
            .addEventListener("click", () => {
              if (currentComicToEdit) {
                currentComicToDelete = currentComicToEdit;
                editModal.classList.remove("show");
                deleteModal.classList.add("show");
              }
            });
        }

        if (document.getElementById("confirm-delete"))
          document
            .getElementById("confirm-delete")
            .addEventListener("click", deleteComic);
        if (document.getElementById("cancel-delete"))
          document
            .getElementById("cancel-delete")
            .addEventListener("click", () =>
              deleteModal.classList.remove("show")
            );
        if (deleteModal)
          deleteModal
            .querySelector(".modal-close")
            .addEventListener("click", () =>
              deleteModal.classList.remove("show")
            );

        if (document.getElementById("category-form")) {
          document
            .getElementById("category-form")
            .addEventListener("submit", async (e) => {
              e.preventDefault();
              const input = document.getElementById("category-name-input");
              const name = input.value.trim();
              if (!name) return;
              try {
                await db
                  .collection("categories")
                  .add({
                    name,
                    value: name.toLowerCase().replace(/\s+/g, "-"),
                  });
                await logActivity("Category Added", name);
                showToast("success", "Added!", `Category "${name}" created.`);
                input.value = "";
              } catch (err) {
                showToast("error", "Error", err.message);
              }
            });
        }

        if (searchInput) {
          searchInput.addEventListener("input", () => {
            const term = searchInput.value.toLowerCase();
            renderAllComics(
              allComics.filter(
                (c) =>
                  c.title.toLowerCase().includes(term) ||
                  (c.author && c.author.toLowerCase().includes(term))
              )
            );
          });
        }

        if (themeToggleBtn) {
          themeToggleBtn.addEventListener("click", () =>
            setTheme(
              document.documentElement.getAttribute("data-theme") === "dark"
                ? "light"
                : "dark"
            )
          );
        }

        if (darkModeToggle) {
          darkModeToggle.addEventListener("change", (e) =>
            setTheme(e.target.checked ? "dark" : "light")
          );
        }

        if (mobileMenuBtn) {
          mobileMenuBtn.addEventListener("click", () => {
            sidebar.classList.add("show");
            sidebarOverlay.classList.add("show");
          });
        }

        if (sidebarOverlay) {
          sidebarOverlay.addEventListener("click", () => {
            sidebar.classList.remove("show");
            sidebarOverlay.classList.remove("show");
          });
        }

        if (recentActivityList) {
          recentActivityList.addEventListener("click", async (e) => {
            const deleteBtn = e.target.closest(".delete-activity-btn");
            if (deleteBtn) {
              const docId = deleteBtn.dataset.id;
              if (!docId) return;
              try {
                await db.collection("activity_log").doc(docId).delete();
                showToast("success", "Activity Deleted", "Log entry removed.");
              } catch (err) {
                showToast("error", "Error", "Could not delete activity log.");
                console.error("Error deleting activity:", err);
              }
            }
          });
        }

        if (deleteAllActivitiesBtn) {
          deleteAllActivitiesBtn.addEventListener("click", () => {
            deleteAllActivitiesModal.classList.add("show");
          });
        }

        if (deleteAllActivitiesModal) {
          deleteAllActivitiesModal
            .querySelector(".modal-close")
            .addEventListener("click", () =>
              deleteAllActivitiesModal.classList.remove("show")
            );
          document
            .getElementById("cancel-delete-all-activities")
            .addEventListener("click", () =>
              deleteAllActivitiesModal.classList.remove("show")
            );
          document
            .getElementById("confirm-delete-all-activities")
            .addEventListener("click", deleteAllActivities);
        }

        if (searchClientsInput) {
          searchClientsInput.addEventListener("input", (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredClients = allClients.filter(
              (client) =>
                (client.displayName &&
                  client.displayName.toLowerCase().includes(searchTerm)) ||
                (client.email &&
                  client.email.toLowerCase().includes(searchTerm))
            );
            renderClientsTable(filteredClients);
          });
        }

        if (clientsListBody) {
          clientsListBody.addEventListener("click", (e) => {
            const deleteBtn = e.target.closest(".delete-client-btn");
            if (deleteBtn) {
              const userId = deleteBtn.dataset.id;
              currentClientToDelete = allClients.find((c) => c.id === userId);
              if (currentClientToDelete && deleteClientModal) {
                deleteClientModal.classList.add("show");
              }
            }
          });
        }

        if (deleteClientModal) {
          deleteClientModal
            .querySelector(".modal-close")
            .addEventListener("click", () =>
              deleteClientModal.classList.remove("show")
            );
          document
            .getElementById("cancel-delete-client")
            .addEventListener("click", () =>
              deleteClientModal.classList.remove("show")
            );
          document
            .getElementById("confirm-delete-client")
            .addEventListener("click", deleteClient);
        }

        if (userProfileImg) {
          userProfileImg.addEventListener("click", () => {
            pfpModal.classList.add("show");
          });
        }

        if (pfpModal) {
          pfpModal
            .querySelector(".modal-close")
            .addEventListener("click", () => pfpModal.classList.remove("show"));
          document
            .getElementById("cancel-pfp-change")
            .addEventListener("click", () => pfpModal.classList.remove("show"));
          savePfpBtn.addEventListener("click", savePfpChange);
        }

        if (presetAvatarsGrid) {
          presetAvatarsGrid.addEventListener("click", (e) => {
            if (e.target.classList.contains("preset-avatar")) {
              presetAvatarsGrid
                .querySelectorAll(".preset-avatar")
                .forEach((img) => img.classList.remove("selected"));
              e.target.classList.add("selected");
              selectedPfpUrl = e.target.dataset.url;
              savePfpBtn.classList.remove("hidden");
            }
          });
        }

        if (backupBtn) backupBtn.addEventListener("click", backupData);
        if (restoreBtn)
          restoreBtn.addEventListener("click", () => restoreFileInput.click());
        if (restoreFileInput)
          restoreFileInput.addEventListener("change", handleFileSelect);

        if (restoreConfirmModal) {
          restoreConfirmModal
            .querySelector(".modal-close")
            .addEventListener("click", () =>
              restoreConfirmModal.classList.remove("show")
            );
          document
            .getElementById("cancel-restore")
            .addEventListener("click", () =>
              restoreConfirmModal.classList.remove("show")
            );
          document
            .getElementById("confirm-restore")
            .addEventListener("click", restoreData);
        }

        if (clearCacheBtn) {
          clearCacheBtn.addEventListener("click", () => {
            clearCacheModal.classList.add("show");
          });
        }

        if (clearCacheModal) {
          clearCacheModal
            .querySelector(".modal-close")
            .addEventListener("click", () =>
              clearCacheModal.classList.remove("show")
            );
          document
            .getElementById("cancel-clear-cache")
            .addEventListener("click", () =>
              clearCacheModal.classList.remove("show")
            );
          document
            .getElementById("confirm-clear-cache")
            .addEventListener("click", clearBrowserCache);
        }

        if (addUserBtn) {
          addUserBtn.addEventListener("click", () =>
            addUserModal.classList.add("show")
          );
        }
        if (addUserModal) {
          addUserModal
            .querySelector(".modal-close")
            .addEventListener("click", () =>
              addUserModal.classList.remove("show")
            );
          document
            .getElementById("cancel-add-user")
            .addEventListener("click", () =>
              addUserModal.classList.remove("show")
            );
          document
            .getElementById("confirm-add-user")
            .addEventListener("click", addNewClient);
        }
      });
    </script>
  </body>
</html>
